## Define the stages & order of execution

stages:
  - CLUSTER-SETUP
  - INFRA-SETUP
  - APP-FUNC-TEST
  - UPGRADE-OPENEBS
  - APP-CHAOS-TEST  
##########################################################################################

Cluster-Setup:
  image: openebs/openshift-ci:latest
  stage: CLUSTER-SETUP
  script:     
    - chmod 755 ./openebs-openshift-e2e/script/1-cluster-setup/cluster-setup
    - ./openebs-openshift-e2e/script/1-cluster-setup/cluster-setup

##########################################################################################

.infra_setup_template:
  image: openebs/openshift-ci:latest
  stage: INFRA-SETUP
  when: always
  dependencies:
    - Cluster-Setup

CSTOR-OPERATOR:
  extends: .infra_setup_template
  script:
    - chmod 755 ./openebs-openshift-e2e/script/2-infra-setup/cstor-cspc-operator/cspc-cstor-operator
    - ./openebs-openshift-e2e/script/2-infra-setup/cstor-cspc-operator/cspc-cstor-operator

STRIPED-POOL-PROVISION:
  extends: .infra_setup_template
  script:
    - chmod 775 ./openebs-openshift-e2e/script/2-infra-setup/create-striped-pool/create-striped-pool
    - ./openebs-openshift-e2e/script/2-infra-setup/create-striped-pool/create-striped-pool

STORAGE-CLASSES:
  extends: .infra_setup_template
  script:
    - chmod 775 ./openebs-openshift-e2e/script/2-infra-setup/storage-policies/openebs-sc
    - ./openebs-openshift-e2e/script/2-infra-setup/storage-policies/openebs-sc

###########################################################################################

.func_test_template:
  image: openebs/openshift-ci:latest
  stage: APP-FUNC-TEST
  when: always
  dependencies:
    - Cluster-Setup

busybox-deployment-cstor:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-openshift-e2e/script/3-functional/busybox-deployment-cstor/busybox-deployment-cstor
    - ./openebs-openshift-e2e/script/3-functional/busybox-deployment-cstor/busybox-deployment-cstor

percona-deployment-cstor:
  extends: .func_test_template
  script:
    - chmod 775 ./openebs-openshift-e2e/script/3-functional/percona-deployment-cstor/percona-deployment-cstor
    - ./openebs-openshift-e2e/script/3-functional/percona-deployment-cstor/percona-deployment-cstor

###########################################################################################

.upgrade_openebs:
  image: openebs/openshift-ci:latest
  stage: UPGRADE-OPENEBS
  when: always
  dependencies:
    - Cluster-Setup

upgrade-cstor-operator:
  extends: .upgrade_openebs
  script:
    - chmod 775 ./openebs-openshift-e2e/script/4-upgrade-openebs/upgrade-cstor-operator
    - ./openebs-openshift-e2e/script/4-upgrade-openebs/upgrade-cstor-operator

upgrade-cspc-csi:
  extends: .upgrade_openebs
  script:
    - chmod 775 ./openebs-openshift-e2e/script/4-upgrade-openebs/upgrade-cstor-csi
    - ./openebs-openshift-e2e/script/4-upgrade-openebs/upgrade-cstor-csi

###########################################################################################

.chaos_test_template:
  image: openebs/openshift-ci:latest
  stage: APP-CHAOS-TEST
  when: always
  dependencies:
    - Cluster-Setup

busybox-target-kill:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-openshift-e2e/script/5-chaos/bb-target-kill
    - ./openebs-openshift-e2e/script/5-chaos/bb-target-kill

busybox-deployment-target-network-delay:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-openshift-e2e/script/5-chaos/bb-deployment-target-nw-delay
    - ./openebs-openshift-e2e/script/5-chaos/bb-deployment-target-nw-delay

percona-target-network-delay:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-openshift-e2e/script/5-chaos/percona-target-nw-delay
    - ./openebs-openshift-e2e/script/5-chaos/percona-target-nw-delay

percona-cstor:
  extends: .chaos_test_template
  script:
    - chmod 775 ./openebs-openshift-e2e/script/5-chaos/percona-deployment-cstor
    - ./openebs-openshift-e2e/script/5-chaos/percona-deployment-cstor